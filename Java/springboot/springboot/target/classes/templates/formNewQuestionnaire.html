<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CuestGen</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>
    <link href="/styles.css" rel="stylesheet">

</head>
<body>
<script th:inline="javascript">
    /*<![CDATA[*/
    const QUESTION_TYPES = [[${questionTypes}]];
    /*]]>*/
</script>

<div th:replace="~{fragments/navbar :: body}"></div>
<h1 th:text="${newQuestionnaire}?'Nuevo Cuestionario':'Modificar Cuestionario'"></h1>
<h1 th:text="${newQuestionnaire} ? 'Nuevo Cuestionario' : 'Modificar Cuestionario'"></h1>
<div class="container">
    <form method="post" th:action="@{/questionnaire/save}" th:object="${questionnaire}">
        <div class="form-group">
            <label for="title">Título</label>
            <input type="text" class="form-control" id="title" placeholder="Introduce título" th:field="*{title}">
        </div>
        <div class="form-group">
            <label for="desc">Descripción</label>
            <input type="text" class="form-control" id="desc" placeholder="Introduce descripción" th:field="*{description}">
        </div>

        <h3>Preguntas</h3>
        <div id="questionsContainer">
        </div>

        <button type="button" class="btn btn-secondary" onclick="addQuestionField()">Añadir Pregunta</button>

        <input class="btn btn-primary" style="margin-top: 10px" th:value="${newQuestionnaire} ? 'Guardar' : 'Modificar'" type="submit">
    </form>
</div>

<script>
    function addQuestionField() {
        const container = document.getElementById("questionsContainer");
        const index = container.children.length;

        const div = document.createElement("div");
        div.classList.add("card", "p-3", "mb-3");

        // Question input
        const questionInput = document.createElement("input");
        questionInput.type = "text";
        questionInput.classList.add("form-control", "mb-2");
        questionInput.placeholder = "Pregunta";
        questionInput.name = `questions[${index}].text`;

        // Type selector
        const typeSelect = document.createElement("select");
        typeSelect.classList.add("form-control", "mb-3");
        typeSelect.name = `questions[${index}].type`;

        QUESTION_TYPES.forEach((t, idx) => {
            const option = document.createElement("option");
            option.value = t.code;
            option.textContent = t.description;
            if (idx === 0) option.selected = true;
            typeSelect.appendChild(option);
        });

        // Answers section (starts hidden for OPEN)
        const answerGroup = document.createElement("div");
        answerGroup.classList.add("form-group");

        const answerLabel = document.createElement("label");
        answerLabel.textContent = "Respuestas";

        const answerContainer = document.createElement("div");
        answerContainer.id = `answers-${index}`;

        answerGroup.appendChild(answerLabel);
        answerGroup.appendChild(answerContainer);

        // Add Answer button
        const addAnswerButton = document.createElement("button");
        addAnswerButton.type = "button";
        addAnswerButton.classList.add("btn", "btn-sm", "btn-outline-primary", "mt-2");
        addAnswerButton.textContent = "Añadir Respuesta";
        addAnswerButton.setAttribute("onclick", `addAnswer(${index})`);

        // Wrap answers + button
        const answerWrapper = document.createElement("div");
        answerWrapper.appendChild(answerGroup);
        answerWrapper.appendChild(addAnswerButton);

        // Attach toggle logic based on type
        const updateVisibility = () => {
            const typeCode = typeSelect.value;
            const allowsAnswers = ['MO', 'OR', 'BOOL'].includes(typeCode);
            answerWrapper.style.display = allowsAnswers ? 'block' : 'none';
        };

        typeSelect.addEventListener('change', updateVisibility);

        // Set initial visibility
        updateVisibility();

        // Add everything to the card
        div.appendChild(questionInput);
        div.appendChild(typeSelect);
        div.appendChild(answerWrapper);

        container.appendChild(div);
    }
</script>

<script>
    function addAnswer(questionIndex) {
        const container = document.getElementById(`answers-${questionIndex}`);
        const currentCount = container.children.length;

        const div = document.createElement("div");
        div.classList.add("d-flex", "mb-2", "gap-2", "align-items-center");

        const input = document.createElement("input");
        input.type = "text";
        input.className = "form-control";
        input.name = `questions[${questionIndex}].answers[${currentCount}]`;

        const radio = document.createElement("input");
        radio.type = "radio";
        radio.name = `questions[${questionIndex}].correctAnswer`;

        input.addEventListener('input', () => {
            radio.value = input.value;
        });

        div.appendChild(input);
        div.appendChild(radio);
        container.appendChild(div);
        container.scrollIntoView({ behavior: "smooth", block: "center" });
    }
</script>


</body>
</html>